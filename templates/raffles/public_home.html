{% extends 'base_public.html' %}
{% load static %}

{% block title %}
  Início - Sistema de Cotas
{% endblock %}

{% block extra_css %}
  <style>
    .product-card {
      transition: transform 0.2s ease-in-out;
      border: none;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }
    
    .progress-bar {
      height: 8px;
      border-radius: 4px;
    }
    
    .price-display {
      font-size: 1.5rem;
      font-weight: bold;
      color: #28a745;
    }
    
    .order-form {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 2rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .stats-item {
      text-align: center;
      padding: 1rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .stats-number {
      font-size: 2rem;
      font-weight: bold;
      color: #007bff;
    }
    
    .stats-label {
      color: #6c757d;
      font-size: 0.9rem;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="container py-5">
    <!-- Hero Section -->
    <div class="row mb-5">
      <div class="col-lg-8 mx-auto text-center">
        <h1 class="display-4 fw-bold text-primary mb-3">
          <i class="bi bi-ticket-perforated"></i>
          Sistema de Cotas
        </h1>
        <p class="lead text-muted">Participe dos nossos sorteios! Escolha um produto, compre suas cotas e concorra a prêmios incríveis. Os números são sorteados automaticamente para garantir total transparência.</p>
      </div>
    </div>

    <!-- Products Section -->
    <div class="row mb-5">
      <div class="col-12">
        <h2 class="h3 mb-4 text-center">
          <i class="bi bi-gift"></i>
          Produtos em Sorteio
        </h2>
      </div>

      {% if products %}
        {% for product in products %}
          <div class="col-lg-4 col-md-6 mb-4">
            <div class="card product-card h-100">
              {% if product.image %}
                <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.title }}" style="height: 200px; object-fit: cover;" />
              {% else %}
                <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                  <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                </div>
              {% endif %}

              <div class="card-body d-flex flex-column">
                <h5 class="card-title">{{ product.title }}</h5>
                <p class="card-text text-muted small">{{ product.description|truncatewords:20 }}</p>

                <div class="mt-auto">
                  <div class="price-display mb-3">
                    {{ product.price_display }} <small class="text-muted">por cota</small>
                  </div>

                  <!-- Progress Bar -->
                  <div class="mb-3">
                    <div class="d-flex justify-content-between small text-muted mb-1">
                      <span>{{ product.sold_count }} vendidas</span>
                      <span>{{ product.available_count }} disponíveis</span>
                    </div>
                    <div class="progress">
                      <div class="progress-bar bg-success" role="progressbar" style="width: {{ product.progress_percentage }}%">{{ product.progress_percentage }}%</div>
                    </div>
                  </div>

                  <!-- Stats -->
                  <div class="row text-center mb-3">
                    <div class="col-4">
                      <div class="stats-item">
                        <div class="stats-number">{{ product.total_quotas }}</div>
                        <div class="stats-label">Total</div>
                      </div>
                    </div>
                    <div class="col-4">
                      <div class="stats-item">
                        <div class="stats-number text-success">{{ product.sold_count }}</div>
                        <div class="stats-label">Vendidas</div>
                      </div>
                    </div>
                    <div class="col-4">
                      <div class="stats-item">
                        <div class="stats-number text-warning">{{ product.reserved_count }}</div>
                        <div class="stats-label">Reservadas</div>
                      </div>
                    </div>
                  </div>

                  <!-- Draw Date -->
                  {% if product.draw_datetime %}
                    <div class="text-center mb-3">
                      <small class="text-muted">
                        <i class="bi bi-calendar-event"></i>
                        Sorteio: {{ product.draw_datetime|date:'d/m/Y à\s H:i' }}
                      </small>
                    </div>
                  {% endif %}

                  <!-- Action Buttons -->
                  <div class="d-grid gap-2">
                    <a href="{% url 'raffles:product_detail' product.id %}" class="btn btn-outline-primary btn-sm"><i class="bi bi-eye"></i> Ver Detalhes</a>
                    {% if product.available_count > 0 %}
                      <button class="btn btn-primary btn-sm" onclick="selectProduct({{ product.id }})"><i class="bi bi-cart-plus"></i> Comprar Cotas</button>
                    {% else %}
                      <button class="btn btn-secondary btn-sm" disabled><i class="bi bi-x-circle"></i> Esgotado</button>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="col-12">
          <div class="text-center py-5">
            <i class="bi bi-inbox display-1 text-muted"></i>
            <h3 class="text-muted mt-3">Nenhum produto disponível</h3>
            <p class="text-muted">Aguarde novos sorteios em breve!</p>
          </div>
        </div>
      {% endif %}
    </div>

    <!-- Order Form Section -->
    <div class="row">
      <div class="col-lg-8 mx-auto">
        <div class="order-form">
          <h3 class="text-center mb-4">
            <i class="bi bi-cart-check"></i>
            Comprar Cotas
          </h3>

          <form method="post" enctype="multipart/form-data" id="orderForm">
            {% csrf_token %}

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="{{ form.product.id_for_label }}" class="form-label">{{ form.product.label }}</label>
                {{ form.product }}
                {% if form.product.errors %}
                  <div class="invalid-feedback d-block">{{ form.product.errors.0 }}</div>
                {% endif %}
              </div>

              <div class="col-md-6 mb-3">
                <label for="{{ form.quantity.id_for_label }}" class="form-label">{{ form.quantity.label }}</label>
                {{ form.quantity }}
                {% if form.quantity.errors %}
                  <div class="invalid-feedback d-block">{{ form.quantity.errors.0 }}</div>
                {% endif %}
              </div>
            </div>

            <div class="mb-3">
              <label for="{{ form.full_name.id_for_label }}" class="form-label">{{ form.full_name.label }}</label>
              {{ form.full_name }}
              {% if form.full_name.errors %}
                <div class="invalid-feedback d-block">{{ form.full_name.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="{{ form.email.id_for_label }}" class="form-label">{{ form.email.label }}</label>
                {{ form.email }}
                {% if form.email.errors %}
                  <div class="invalid-feedback d-block">{{ form.email.errors.0 }}</div>
                {% endif %}
              </div>

              <div class="col-md-6 mb-3">
                <label for="{{ form.whatsapp.id_for_label }}" class="form-label">{{ form.whatsapp.label }}</label>
                {{ form.whatsapp }}
                {% if form.whatsapp.errors %}
                  <div class="invalid-feedback d-block">{{ form.whatsapp.errors.0 }}</div>
                {% endif %}
              </div>
            </div>

            <div class="mb-3">
              <label for="{{ form.receipt.id_for_label }}" class="form-label">{{ form.receipt.label }}</label>
              {{ form.receipt }}
              {% if form.receipt.help_text %}
                <div class="form-text">{{ form.receipt.help_text }}</div>
              {% endif %}
              {% if form.receipt.errors %}
                <div class="invalid-feedback d-block">{{ form.receipt.errors.0 }}</div>
              {% endif %}
            </div>

            <!-- Total Display -->
            <div class="alert alert-info" id="totalDisplay" style="display: none;">
              <div class="d-flex justify-content-between align-items-center">
                <span><strong>Total a pagar:</strong></span>
                <span class="fs-5" id="totalAmount">R$ 0,00</span>
              </div>
            </div>

            <!-- Important Info -->
            <div class="alert alert-warning">
              <h6><i class="bi bi-info-circle"></i> Informações Importantes:</h6>
              <ul class="mb-0 small">
                <li>Os números das cotas são sorteados automaticamente pelo sistema</li>
                <li>Você tem 15 minutos para confirmar seu pedido</li>
                <li>O comprovante de pagamento é opcional no momento da compra</li>
                <li>Você pode enviar o comprovante depois através do link que será fornecido</li>
              </ul>
            </div>

            <!-- Submit Button -->
            <div class="d-grid">
              <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                <i class="bi bi-cart-check"></i>
                Finalizar Pedido
              </button>
            </div>

            {% if form.non_field_errors %}
              <div class="alert alert-danger mt-3">{{ form.non_field_errors.0 }}</div>
            {% endif %}
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    // Product selection and price calculation
    function selectProduct(productId) {
      document.getElementById('id_product').value = productId
      updateTotal()
    }
    
    function updateTotal() {
      const productSelect = document.getElementById('id_product')
      const quantityInput = document.getElementById('id_quantity')
      const totalDisplay = document.getElementById('totalDisplay')
      const totalAmount = document.getElementById('totalAmount')
    
      if (productSelect.value && quantityInput.value) {
        // Get product price from the selected option's data attribute
        const selectedOption = productSelect.options[productSelect.selectedIndex]
        const priceCents = parseInt(selectedOption.dataset.price || 0)
        const quantity = parseInt(quantityInput.value) || 0
        const totalCents = priceCents * quantity
    
        if (totalCents > 0) {
          const totalReais = (totalCents / 100).toFixed(2).replace('.', ',')
          totalAmount.textContent = 'R$ ' + totalReais
          totalDisplay.style.display = 'block'
        } else {
          totalDisplay.style.display = 'none'
        }
      } else {
        totalDisplay.style.display = 'none'
      }
    }
    
    // Event listeners
    document.getElementById('id_product').addEventListener('change', updateTotal)
    document.getElementById('id_quantity').addEventListener('input', updateTotal)
    
    // Form submission with loading state
    document.getElementById('orderForm').addEventListener('submit', function (e) {
      const submitBtn = document.getElementById('submitBtn')
      submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processando...'
      submitBtn.disabled = true
    })
    
    // Initialize total calculation if form has values
    document.addEventListener('DOMContentLoaded', function () {
      updateTotal()
    })
  </script>
{% endblock %}
