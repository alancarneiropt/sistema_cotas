{% extends 'raffles/base_admin.html' %}
{% load static %}

{% block title %}
  Histórico de Pedidos - Sistema de Cotas
{% endblock %}

{% block page_title %}
  <i class="bi bi-clock-history me-2"></i>
  Histórico de Pedidos
{% endblock %}

{% block content %}
  <!-- Filters Card -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="bi bi-funnel me-2"></i>
        Filtros e Busca
      </h5>
    </div>
    <div class="card-body">
      <form method="get" class="row g-3">
        <div class="col-md-3">
          <label for="status" class="form-label">Status</label>
          <select name="status" id="status" class="form-select">
            <option value="">Todos os status</option>
            <option value="reservado" {% if status_filter == 'reservado' %}selected{% endif %}>Reservado</option>
            <option value="aguardando_comprovante" {% if status_filter == 'aguardando_comprovante' %}selected{% endif %}>Aguardando Comprovante</option>
            <option value="aguardando_confirmacao" {% if status_filter == 'aguardando_confirmacao' %}selected{% endif %}>Aguardando Confirmação</option>
            <option value="confirmado" {% if status_filter == 'confirmado' %}selected{% endif %}>Confirmado</option>
            <option value="cancelado" {% if status_filter == 'cancelado' %}selected{% endif %}>Cancelado</option>
            <option value="expirado" {% if status_filter == 'expirado' %}selected{% endif %}>Expirado</option>
          </select>
        </div>
        
        <div class="col-md-3">
          <label for="product" class="form-label">Produto</label>
          <select name="product" id="product" class="form-select">
            <option value="">Todos os produtos</option>
            {% for product in products %}
              <option value="{{ product.id }}" {% if product_filter == product.id|stringformat:"s" %}selected{% endif %}>
                {{ product.title }}
              </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="col-md-4">
          <label for="search" class="form-label">Buscar</label>
          <input type="text" 
                 class="form-control" 
                 id="search" 
                 name="search" 
                 placeholder="Nome, e-mail, WhatsApp ou ID do pedido..."
                 value="{{ search_filter }}">
        </div>
        
        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-primary me-2">
            <i class="bi bi-search"></i>
            Filtrar
          </button>
          <a href="{% url 'raffles:admin_order_history' %}" class="btn btn-outline-secondary">
            <i class="bi bi-x-circle"></i>
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
      <div class="stats-card">
        <div class="stats-icon primary">
          <i class="bi bi-cart"></i>
        </div>
        <div class="stats-number">{{ page_obj.paginator.count }}</div>
        <div class="stats-label">Total de Pedidos</div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="stats-card">
        <div class="stats-icon success">
          <i class="bi bi-list-check"></i>
        </div>
        <div class="stats-number">{{ orders|length }}</div>
        <div class="stats-label">Página Atual</div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="stats-card">
        <div class="stats-icon warning">
          <i class="bi bi-file-earmark-text"></i>
        </div>
        <div class="stats-number">{{ page_obj.number }}</div>
        <div class="stats-label">de {{ page_obj.paginator.num_pages }}</div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="stats-card">
        <div class="stats-icon info">
          <i class="bi bi-grid"></i>
        </div>
        <div class="stats-number">50</div>
        <div class="stats-label">Por Página</div>
      </div>
    </div>
  </div>

  <!-- Orders Table -->
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="bi bi-table me-2"></i>
        Lista de Pedidos
      </h5>
    </div>
    <div class="card-body">
      {% if orders %}
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Contato</th>
                <th>Produto</th>
                <th>Quantidade</th>
                <th>Status</th>
                <th>Valor</th>
                <th>Data</th>
                <th>Comprovante</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              {% for order in orders %}
                <tr>
                  <td>
                    <strong>#{{ order.id }}</strong>
                  </td>
                  <td>
                    <div>
                      <strong>{{ order.full_name }}</strong>
                    </div>
                  </td>
                  <td>
                    <div class="small">
                      {% if order.email %}
                        <div><i class="bi bi-envelope"></i> {{ order.email }}</div>
                      {% endif %}
                      {% if order.whatsapp %}
                        <div><i class="bi bi-whatsapp"></i> {{ order.whatsapp }}</div>
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    <small>{{ order.product.title }}</small>
                  </td>
                  <td>
                    <span class="badge bg-info">{{ order.quantity }}</span>
                  </td>
                  <td>
                    <span class="badge bg-{% if order.status == 'confirmado' %}success{% elif order.status == 'cancelado' %}danger{% elif order.status == 'expirado' %}secondary{% else %}warning{% endif %}">
                      {{ order.get_status_display }}
                    </span>
                  </td>
                  <td>
                    <strong>{{ order.total_price_display }}</strong>
                  </td>
                  <td>
                    <div class="small">
                      {{ order.created_at|date:"d/m/Y" }}<br>
                      {{ order.created_at|date:"H:i" }}
                    </div>
                  </td>
                  <td>
                    {% if order.receipt %}
                      <a href="{{ order.receipt.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-download"></i>
                      </a>
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <a href="{% url 'raffles:admin_order_detail_full' order.id %}" 
                         class="btn btn-outline-primary" 
                         title="Ver Detalhes Completos">
                        <i class="bi bi-eye"></i>
                      </a>
                      <a href="{% url 'raffles:admin_order_detail' order.id %}" 
                         class="btn btn-outline-secondary" 
                         title="Ver Resumo">
                        <i class="bi bi-list"></i>
                      </a>
                      
                      {% if order.status == 'aguardando_confirmacao' and order.receipt %}
                        <a href="{% url 'raffles:confirm_order_with_receipt' order.id %}" 
                           class="btn btn-success" 
                           title="Confirmar com Comprovante"
                           onclick="return confirm('Confirmar com comprovante?')">
                          <i class="bi bi-check-circle"></i>
                        </a>
                      {% endif %}
                      
                      {% if order.status == 'reservado' or order.status == 'aguardando_confirmacao' %}
                        <a href="{% url 'raffles:confirm_order_without_receipt' order.id %}" 
                           class="btn btn-warning" 
                           title="Confirmar sem Comprovante"
                           onclick="return confirm('⚠️ Confirmar SEM comprovante?')">
                          <i class="bi bi-exclamation-triangle"></i>
                        </a>
                      {% endif %}
                      
                      <a href="/admin/raffles/order/{{ order.id }}/change/" 
                         class="btn btn-outline-info" 
                         title="Editar">
                        <i class="bi bi-pencil"></i>
                      </a>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
          <nav aria-label="Navegação de páginas" class="mt-4">
            <ul class="pagination justify-content-center">
              {% if page_obj.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page=1{% if status_filter %}&status={{ status_filter }}{% endif %}{% if product_filter %}&product={{ product_filter }}{% endif %}{% if search_filter %}&search={{ search_filter }}{% endif %}">Primeira</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if product_filter %}&product={{ product_filter }}{% endif %}{% if search_filter %}&search={{ search_filter }}{% endif %}">Anterior</a>
                </li>
              {% endif %}

              <li class="page-item active">
                <span class="page-link">
                  Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                </span>
              </li>

              {% if page_obj.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if product_filter %}&product={{ product_filter }}{% endif %}{% if search_filter %}&search={{ search_filter }}{% endif %}">Próxima</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if product_filter %}&product={{ product_filter }}{% endif %}{% if search_filter %}&search={{ search_filter }}{% endif %}">Última</a>
                </li>
              {% endif %}
            </ul>
          </nav>
        {% endif %}
      {% else %}
        <div class="text-center py-5">
          <i class="bi bi-inbox display-1 text-muted"></i>
          <h3 class="text-muted mt-3">Nenhum pedido encontrado</h3>
          <p class="text-muted">Não há pedidos que correspondam aos filtros aplicados.</p>
          <a href="{% url 'raffles:admin_order_history' %}" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left"></i>
            Limpar Filtros
          </a>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block extra_css %}
<style>
  .form-control, .form-select {
    border-radius: 10px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
  }
  
  .form-control:focus, .form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
  }
  
  .btn-group-sm .btn {
    padding: 0.375rem 0.75rem;
    border-radius: 8px;
  }
  
  .table th {
    font-weight: 600;
    color: #2c3e50;
  }
  
  .badge {
    font-size: 0.75rem;
    padding: 0.5rem 0.75rem;
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  // Auto-submit form on filter change
  document.getElementById('status').addEventListener('change', function() {
    this.form.submit();
  });
  
  document.getElementById('product').addEventListener('change', function() {
    this.form.submit();
  });
  
  // Search with debounce
  let searchTimeout;
  document.getElementById('search').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      this.form.submit();
    }, 500);
  });
  
  // Add loading state to buttons
  document.querySelectorAll('.btn').forEach(btn => {
    btn.addEventListener('click', function() {
      if (this.type === 'submit') {
        const loading = document.createElement('span');
        loading.className = 'loading me-2';
        this.insertBefore(loading, this.firstChild);
        this.disabled = true;
      }
    });
  });
</script>
{% endblock %}
